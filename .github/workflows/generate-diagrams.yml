name: diagrams

on:
  pull_request:
    paths:
      - 'src/**'
      - 'scripts/generate_*'
      - 'package.json'
      - 'tsconfig*.json'

jobs:
  build-diagrams:
    runs-on: ubuntu-22.04

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.9.0
          cache: 'npm'

      - name: Install Chromium system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 libatk-bridge2.0-0 libxcb-dri3-0 \
            libxkbcommon0 libdrm2 libgbm1
          echo 'PUPPETEER_SKIP_DOWNLOAD=1' >> $GITHUB_ENV

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Puppeteer Headless Chrome
        run: npx puppeteer browsers install chrome-headless-shell

      - name: Generate diagrams
        run: pnpm run diagram:all

      - name: Commit diagrams
        uses: EndBug/add-and-commit@v9
        with:
          add: 'docs/*.svg docs/*.mmd'
          message: 'chore: auto-update diagrams [skip ci]'
          default_author: github_actions
          push: origin HEAD:${{ github.head_ref }}
          commit: --signoff

      - name: Upload diagrams as artefact
        uses: actions/upload-artifact@v4
        with:
          name: diagrams
          path: docs/*.svg

      - name: Write PR summary (visible under â€œChecks â†’ Summaryâ€)
        run: |
          echo '### ðŸ“Š Updated diagrams' >> $GITHUB_STEP_SUMMARY
          echo '![](docs/class.svg)'     >> $GITHUB_STEP_SUMMARY
          echo '![](docs/deps.svg)'      >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… **Diagrams rebuilt**
            <details>
            <summary>Click to expand</summary>

            ![](../blob/${{ github.event.pull_request.head.ref }}/docs/class.svg?raw=true)
            ![](../blob/${{ github.event.pull_request.head.ref }}/docs/deps.svg?raw=true)
            
            </details>
